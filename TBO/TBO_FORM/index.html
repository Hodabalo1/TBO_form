
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Questionnaire TBO – ASECNA / EAMAC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <style>
        *{box-sizing:border-box}
        body{margin:0;font-family:"Segoe UI",Tahoma,Arial,sans-serif;background:linear-gradient(180deg,#f5f8fc,#eef6ff);color:#0b2b4a}
        header{display:flex;align-items:center;justify-content:space-between;background:#fff;border-bottom:3px solid #004b8d;padding:12px 18px;gap:12px}
        .logo-left img,.logo-right img{height:72px;width:auto;display:block}
        .header-center{text-align:center;flex:1}
        .project-title{font-weight:800;color:#003e78;font-size:18px;margin:0}
        .project-sub{font-size:12px;color:#315573;margin:2px 0 0}
        main{max-width:1100px;margin:18px auto;padding:12px}
        .card{background:#fff;border-radius:10px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(15,30,60,0.06)}
        label{display:block;margin-top:10px;font-weight:600}
        select,textarea,input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd7ea;background:#fff;margin-top:6px;font-size:14px}
        button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;transition:all 0.3s ease}
        .btn-primary{background:#0a6cf1;color:#fff}
        .btn-primary:hover{background:#095cd0}
        .btn-primary:disabled{background:#ccc;cursor:not-allowed}
        .btn-ghost{background:transparent;border:1px solid #cfddea;color:#234567}
        .btn-ghost:hover{background:#f5f9ff}
        .muted{color:#556b81;font-size:13px}
        .grid-2{display:grid;grid-template-columns:1fr 360px;gap:14px}
        @media(max-width:1000px){.grid-2{grid-template-columns:1fr}.logo-left img,.logo-right img{height:58px}}
        .question-block{margin-top:12px;padding:12px;border-radius:8px;background:#fbfdff;border:1px solid #eef5ff}
        .q-title{font-weight:700;margin-bottom:8px;color:#023b6a}
        .options{display:flex;gap:10px;flex-wrap:wrap}
        .option{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #dbeafc;cursor:pointer;transition:all 0.2s ease}
        .radio-inline{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:#fff;border:1px solid #e6f0ff;cursor:pointer;transition:all 0.2s ease}
        .option input,.radio-inline input{cursor:pointer}
        .option.selected,.radio-inline.selected{background:linear-gradient(180deg,#e8f2ff,#dff0ff);border-color:#90c1ff;box-shadow:0 2px 6px rgba(30,80,140,0.06)}
        .info{display:inline-block;margin-left:8px;color:#0056b3;border-radius:50%;width:20px;height:20px;line-height:18px;text-align:center;border:1px solid #cfe6ff;background:#f6fbff;font-size:12px;position:relative;cursor:help}
        .info:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 10px);background:#0b2b4a;color:#fff;padding:8px 10px;border-radius:6px;white-space:pre-line;font-size:13px;max-width:320px;z-index:60;box-shadow:0 6px 20px rgba(10,30,80,0.25)}
        .hidden{display:none}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:8px 10px;border-bottom:1px solid #eef4ff;text-align:left}
        th{background:#f8fbff;position:sticky;top:0}
        .obs{min-height:80px;resize:vertical}
        .table-responsive{overflow:auto;max-height:400px;border:1px solid #e6f0ff;border-radius:8px}
        .loading{opacity:0.6;pointer-events:none}
        .success-message{background:#e8f5e8;color:#2d5016;padding:12px;border-radius:6px;margin:10px 0;border:1px solid #c3e6c3}
        .error-message{background:#fde8e8;color:#c53030;padding:12px;border-radius:6px;margin:10px 0;border:1px solid #f5c6cb}
        .required{color:#e53e3e}
    </style>
</head>
<body>
    <header>
        <div class="logo-left"><img src="asecna-logo.png" alt="ASECNA logo" /></div>
        <div class="header-center">
            <div class="project-title">Questionnaire sur l'implémentation et la familiarité avec le TBO</div>
            <div class="project-sub">ASECNA — EAMAC — Personnel opérationnel & pilotes</div>
        </div>
        <div class="logo-right"><img src="logo_eamac.png" alt="EAMAC logo" /></div>
    </header>

    <main class="main">
        <section class="card" id="accueil">
            <div class="grid-2">
                <div>
                    <h2>Bienvenue</h2>
                    <p class="muted">
                        Ce questionnaire vise à mesurer le niveau d'implémentation et la familiarité des personnels opérationnels de l'ASECNA et des pilotes avec le concept Trajectory-Based Operations (TBO). Les résultats permettront d'orienter les formations, équipements et la feuille de route régionale.
                    </p>
                    <div style="margin-top:10px;">
                        <strong>Échelle de réponse (Likert)</strong>
                        <div class="muted">1 = Non implémenté &nbsp; | &nbsp; 2 = En cours &nbsp; | &nbsp; 3 = Implémenté et opérationnel</div>
                    </div>
                    <div style="margin-top:12px;">
                        <strong>Glossaire rapide (survolez les sigles pour plus d'infos)</strong>
                        <ul style="margin:8px 0 0 16px; color:#345a78;">
                            <li><strong>STCA</strong> <span class="info" data-tip="STCA = Short Term Conflict Alert\nAlerte automatique de conflit à court terme entre deux trajectoires.">i</span></li>
                            <li><strong>FF-ICE</strong> <span class="info" data-tip="FF-ICE = Flight and Flow Information for a Collaborative Environment\nStandard pour le partage d'informations de vol et de flux.">i</span></li>
                            <li><strong>SWIM</strong> <span class="info" data-tip="SWIM = System Wide Information Management\nCadre pour l'échange standardisé et sécurisé des informations aéronautiques.">i</span></li>
                            <li><strong>AMAN</strong> <span class="info" data-tip="AMAN = Arrival Manager\nOutil d'optimisation et séquencement des arrivées en terminal.">i</span></li>
                            <li><strong>FRA</strong> <span class="info" data-tip="FRA = Free Route Airspace\nEspace aérien permettant des routings directs entre points définis.">i</span></li>
                            <li><strong>AIDC</strong> <span class="info" data-tip="AIDC = ATS Interfacility Data Communication\nProtocole d'échange de messages entre centres ATS.">i</span></li>
                            <li><strong>A-FUA</strong> <span class="info" data-tip="A-FUA = Advanced Flexible Use of Airspace\nApproche avancée de gestion flexible de l'espace aérien.">i</span></li>
                            <li><strong>PBN / RNP AR</strong> <span class="info" data-tip="PBN = Performance-Based Navigation\nRNP AR = Required Navigation Performance Authorization Required (approches avancées).">i</span></li>
                            <li><strong>TTOT</strong> <span class="info" data-tip="TTOT = Target Take-Off Time\nHeure de décollage cible pour un vol (ATFM).">i</span></li>
                            <li><strong>CTOT</strong> <span class="info" data-tip="CTOT = Calculated Take-Off Time\nHeure de décollage calculée/assignée par ATFM.">i</span></li>
                            <li><strong>TTA</strong> <span class="info" data-tip="TTA = Target Time of Arrival\nHeure cible d'arrivée pour un vol (ATFM).">i</span></li>
                            <li><strong>ETA / ATA</strong> <span class="info" data-tip="ETA = Estimated Time of Arrival (estimation)\nATA = Actual Time of Arrival (heure réelle d'arrivée).">i</span></li>
                            <li><strong>AIXM</strong> <span class="info" data-tip="AIXM = Aeronautical Information Exchange Model\nModèle standard pour l'échange d'informations aéronautiques (e-AIP...).">i</span></li>
                            <li><strong>FIXM</strong> <span class="info" data-tip="FIXM = Flight Information Exchange Model\nModèle pour l'échange d'informations de vol entre systèmes.">i</span></li>
                            <li><strong>IWXXM</strong> <span class="info" data-tip="IWXXM = ICAO Weather Information Exchange Model\nModèle standard pour l'échange des messages météorologiques (SIGMET, METAR/TAF...).">i</span></li>
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <label for="country">Pays <span class="required">*</span></label>
                    <select id="country" aria-label="Pays" required>
                        <option value="">-- Sélectionnez votre pays --</option>
                        <option value="Bénin">Bénin</option>
                        <option value="Burkina Faso">Burkina Faso</option>
                        <option value="Cameroun">Cameroun</option>
                        <option value="Centrafrique">Centrafrique</option>
                        <option value="Congo">Congo</option>
                        <option value="Côte d'Ivoire">Côte d'Ivoire</option>
                        <option value="Gabon">Gabon</option>
                        <option value="Guinée">Guinée</option>
                        <option value="Guinée-Bissau">Guinée-Bissau</option>
                        <option value="Guinée Équatoriale">Guinée Équatoriale</option>
                        <option value="Madagascar">Madagascar</option>
                        <option value="Mali">Mali</option>
                        <option value="Mauritanie">Mauritanie</option>
                        <option value="Niger">Niger</option>
                        <option value="Rwanda">Rwanda</option>
                        <option value="Sénégal">Sénégal</option>
                        <option value="Tchad">Tchad</option>
                        <option value="Togo">Togo</option>
                        <option value="Union des Comores">Union des Comores</option>
                    </select>

                    <label for="role">Fonction <span class="required">*</span></label>
                    <select id="role" aria-label="Fonction" required>
                        <option value="">-- Sélectionnez votre fonction --</option>
                        <option value="ATC">Contrôleur aérien (ATC)</option>
                        <option value="ATFM">Chef UQUIP (ATFM)</option>
                        <option value="AIM">Chef AIM</option>
                        <option value="CNS">Chef CNS</option>
                        <option value="Pilote">Pilote</option>
                    </select>

                    <div class="muted" style="margin-top:10px;">
                        Après sélection, cliquez sur <strong>Commencer</strong> pour afficher uniquement le questionnaire lié à votre fonction.
                    </div>

                    <div class="btn-row" style="margin-top:10px;display:flex;gap:10px;">
                        <button id="startBtn" class="btn-primary" disabled>Commencer</button>
                        <button id="adminLink" class="btn-ghost">Espace administrateur</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="questionnaire" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div id="headingRole" style="font-weight:800;color:#023b6a;font-size:16px">Questionnaire</div>
                    <div class="muted" id="subHeading"></div>
                </div>
                <div class="muted">Échelle : 1 = Non implémenté | 2 = En cours | 3 = Implémenté et opérationnel</div>
            </div>

            <!-- ATC Section -->
            <div id="form-ATC" class="question-block hidden" data-func="ATC">
                <div style="font-weight:700;color:#003e78">Contrôleur aérien (ATC)</div>
                
                <div class="q-title">1. Expérience professionnelle dans le domaine aéronautique :</div>
                <div class="options" role="group" aria-label="Expérience ATC">
                    <label class="option"><input type="radio" name="atc_exp" value="Moins de 5 ans">Moins de 5 ans</label>
                    <label class="option"><input type="radio" name="atc_exp" value="5 à 10 ans">5 à 10 ans</label>
                    <label class="option"><input type="radio" name="atc_exp" value="11 à 20 ans">11 à 20 ans</label>
                    <label class="option"><input type="radio" name="atc_exp" value="Plus de 20 ans">Plus de 20 ans</label>
                </div>

                <div class="q-title" style="margin-top:10px">2. À quel point êtes-vous familier avec le concept TBO (Trajectory-Based Operations) ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="atc_fam" value="Pas du tout familier">Pas du tout familier - Je n'en ai jamais entendu parler</label>
                    <label class="option"><input type="radio" name="atc_fam" value="Peu familier">Peu familier - J'en ai entendu parler mais sans plus</label>
                    <label class="option"><input type="radio" name="atc_fam" value="Neutre">Neutre - Je connais le concept superficiellement</label>
                    <label class="option"><input type="radio" name="atc_fam" value="Assez familier">Assez familier - Je comprends les principes de base</label>
                    <label class="option"><input type="radio" name="atc_fam" value="Très familier">Très familier - Je maîtrise le concept en détail</label>
                </div>

                <div style="margin-top:12px;">
                    <div class="q-title">3. STCA <span class="info" data-tip="STCA = Short Term Conflict Alert\nAlerte de conflit à court terme.">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q3" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q3" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q3" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">4. Niveau d'implémentation du FF-ICE <span class="info" data-tip="FF-ICE = Flight and Flow Information for a Collaborative Environment\nStandard de partage d'information de vol.">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q4" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q4" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q4" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">5. Free Route Airspace (FRA) <span class="info" data-tip="FRA = Free Route Airspace\nEspace aérien permettant des routings directs.">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q5" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q5" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q5" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">6. Gestion flexible avancée (A-FUA) <span class="info" data-tip="A-FUA = Advanced Flexible Use of Airspace">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q6" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q6" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q6" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">7. Sectorisation dynamique</div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q7" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q7" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q7" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">8. Outils avancés de prédiction (MTCD, MONA)</div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q8" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q8" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q8" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">9. AMAN <span class="info" data-tip="AMAN = Arrival Manager\nOutil de séquencement et optimisation des arrivées.">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q9" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q9" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q9" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">10. Utilisation des heures cibles (TTOT, CTOT, TTA, ETA/ATA) <span class="info" data-tip="TTOT = Target Take-Off Time\nCTOT = Calculated Take-Off Time\nTTA = Target Time of Arrival\nETA = Estimated Time of Arrival\nATA = Actual Time of Arrival">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q10" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q10" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q10" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">11. Procédures CDO/CCO basiques</div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q11" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q11" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q11" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">12. Procédures CDO/CCO avancées</div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q12" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q12" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q12" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">13. Approches PBN avancées (RNP AR) <span class="info" data-tip="PBN = Performance Based Navigation\nRNP AR = Approches nécessitant autorisation spécifique">i</span></div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q13" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q13" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q13" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <div class="q-title">14. Partage de trajectoire 4D (TBO avancé)</div>
                    <div class="options">
                        <label class="radio-inline"><input type="radio" name="atc_q14" value="1">1</label>
                        <label class="radio-inline"><input type="radio" name="atc_q14" value="2">2</label>
                        <label class="radio-inline"><input type="radio" name="atc_q14" value="3">3</label>
                    </div>
                </div>

                <div style="margin-top:12px;">
                    <div class="q-title">Observations (facultatif)</div>
                    <textarea name="atc_obs" id="atc_obs" class="obs" placeholder="Vos remarques, suggestions ou observations..."></textarea>
                </div>
            </div>

            <!-- ATFM Section -->
            <div id="form-ATFM" class="question-block hidden" data-func="ATFM">
                <div style="font-weight:700;color:#003e78">Chef UQUIP (ATFM)</div>
                
                <div class="q-title">1. Existe-t-il une feuille de route stratégique formalisée pour le TBO à l'ASECNA ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="atfm_q1" value="Oui">Oui</label>
                    <label class="option"><input type="radio" name="atfm_q1" value="Partiellement">Partiellement</label>
                    <label class="option"><input type="radio" name="atfm_q1" value="Non">Non</label>
                </div>

                <div class="q-title" style="margin-top:8px">2. À quel point êtes-vous familier avec le concept TBO ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="atfm_q2" value="Pas du tout familier">Pas du tout familier</label>
                    <label class="option"><input type="radio" name="atfm_q2" value="Peu familier">Peu familier</label>
                    <label class="option"><input type="radio" name="atfm_q2" value="Neutre">Neutre</label>
                    <label class="option"><input type="radio" name="atfm_q2" value="Assez familier">Assez familier</label>
                    <label class="option"><input type="radio" name="atfm_q2" value="Très familier">Très familier</label>
                </div>

                <div class="q-title" style="margin-top:8px">3. STCA</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="atfm_q3" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q3" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q3" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">4. Mise en place du C-ATFM</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="atfm_q4" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q4" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q4" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">5. Gestion flexible avancée (A-FUA)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="atfm_q5" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q5" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q5" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">6. AMAN</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="atfm_q6" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q6" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q6" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">7. Utilisation des heures cibles</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="atfm_q7" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q7" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="atfm_q7" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">8. Niveau de déploiement ASM/ATFM collaboratif</div>
                <div class="options">
                    <label class="option"><input type="radio" name="atfm_q8" value="Déployé">Déployé</label>
                    <label class="option"><input type="radio" name="atfm_q8" value="Partiel">Partiel</label>
                    <label class="option"><input type="radio" name="atfm_q8" value="Test">Test</label>
                    <label class="option"><input type="radio" name="atfm_q8" value="Non déployé">Non déployé</label>
                </div>

                <div class="q-title" style="margin-top:8px">9. Utilisation des Target Times (TTOT, CTOT, TTA)</div>
                <div class="options">
                    <label class="option"><input type="radio" name="atfm_q9" value="Très fréquente">Très fréquente</label>
                    <label class="option"><input type="radio" name="atfm_q9" value="Fréquente">Fréquente</label>
                    <label class="option"><input type="radio" name="atfm_q9" value="Rare">Rare</label>
                    <label class="option"><input type="radio" name="atfm_q9" value="Jamais">Jamais</label>
                </div>

                <div class="q-title" style="margin-top:8px">10. Importance de l'automatisation ATFM dans le TBO</div>
                <div class="options">
                    <label class="option"><input type="radio" name="atfm_q10" value="Très importante">Très importante</label>
                    <label class="option"><input type="radio" name="atfm_q10" value="Importante">Importante</label>
                    <label class="option"><input type="radio" name="atfm_q10" value="Peu importante">Peu importante</label>
                    <label class="option"><input type="radio" name="atfm_q10" value="Pas importante">Pas importante</label>
                </div>

                <div style="margin-top:12px;">
                    <div class="q-title">Observations (facultatif)</div>
                    <textarea name="atfm_obs" id="atfm_obs" class="obs" placeholder="Vos remarques..."></textarea>
                </div>
            </div>

            <!-- AIM Section -->
            <div id="form-AIM" class="question-block hidden" data-func="AIM">
                <div style="font-weight:700;color:#003e78">Chef AIM</div>
                
                <div class="q-title">1. Transition AIS → AIM numérique (e-AIP, AIXM)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="aim_q1" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="aim_q1" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="aim_q1" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">2. SWIM</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="aim_q2" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="aim_q2" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="aim_q2" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">3. Partage de trajectoire 4D (TBO avancé)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="aim_q3" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="aim_q3" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="aim_q3" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">4. Partage numérique des données de vol (SWIM, AIXM, FIXM, IWXXM)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="aim_q4" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="aim_q4" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="aim_q4" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">5. Existe-t-il une feuille de route stratégique formalisée pour le TBO à l'ASECNA ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="aim_q5" value="Oui">Oui</label>
                    <label class="option"><input type="radio" name="aim_q5" value="Partiellement">Partiellement</label>
                    <label class="option"><input type="radio" name="aim_q5" value="Non">Non</label>
                </div>

                <div class="q-title" style="margin-top:8px">6. À quel point êtes-vous familier avec le concept TBO ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="aim_q6" value="Pas du tout familier">Pas du tout familier</label>
                    <label class="option"><input type="radio" name="aim_q6" value="Peu familier">Peu familier</label>
                    <label class="option"><input type="radio" name="aim_q6" value="Neutre">Neutre</label>
                    <label class="option"><input type="radio" name="aim_q6" value="Assez familier">Assez familier</label>
                    <label class="option"><input type="radio" name="aim_q6" value="Très familier">Très familier</label>
                </div>

                <div style="margin-top:12px;">
                    <div class="q-title">Observations (facultatif)</div>
                    <textarea name="aim_obs" id="aim_obs" class="obs" placeholder="Vos remarques..."></textarea>
                </div>
            </div>

            <!-- CNS Section -->
            <div id="form-CNS" class="question-block hidden" data-func="CNS">
                <div style="font-weight:700;color:#003e78">Chef CNS</div>
                
                <div class="q-title">1. Déploiement progressif de l'AIDC</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="cns_q1" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="cns_q1" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="cns_q1" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">2. Réseau ATN/IPS (migration IP interconnexion ATS)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="cns_q2" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="cns_q2" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="cns_q2" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">3. STCA</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="cns_q3" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="cns_q3" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="cns_q3" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">4. SWIM</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="cns_q4" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="cns_q4" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="cns_q4" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">5. Existe-t-il une feuille de route stratégique formalisée pour le TBO à l'ASECNA ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="cns_q5" value="Oui">Oui</label>
                    <label class="option"><input type="radio" name="cns_q5" value="Partiellement">Partiellement</label>
                    <label class="option"><input type="radio" name="cns_q5" value="Non">Non</label>
                </div>

                <div class="q-title" style="margin-top:8px">6. À quel point êtes-vous familier avec le concept TBO ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="cns_q6" value="Pas du tout familier">Pas du tout familier</label>
                    <label class="option"><input type="radio" name="cns_q6" value="Peu familier">Peu familier</label>
                    <label class="option"><input type="radio" name="cns_q6" value="Neutre">Neutre</label>
                    <label class="option"><input type="radio" name="cns_q6" value="Assez familier">Assez familier</label>
                    <label class="option"><input type="radio" name="cns_q6" value="Très familier">Très familier</label>
                </div>

                <div style="margin-top:12px;">
                    <div class="q-title">Observations (facultatif)</div>
                    <textarea name="cns_obs" id="cns_obs" class="obs" placeholder="Vos remarques..."></textarea>
                </div>
            </div>

            <!-- Pilote Section -->
            <div id="form-Pilote" class="question-block hidden" data-func="Pilote">
                <div style="font-weight:700;color:#003e78">Pilote</div>
                
                <div class="q-title">1. Expérience professionnelle dans le domaine aéronautique :</div>
                <div class="options">
                    <label class="option"><input type="radio" name="pilot_exp" value="Moins de 5 ans">Moins de 5 ans</label>
                    <label class="option"><input type="radio" name="pilot_exp" value="5 à 10 ans">5 à 10 ans</label>
                    <label class="option"><input type="radio" name="pilot_exp" value="11 à 20 ans">11 à 20 ans</label>
                    <label class="option"><input type="radio" name="pilot_exp" value="Plus de 20 ans">Plus de 20 ans</label>
                </div>

                <div class="q-title" style="margin-top:8px">2. À quel point êtes-vous familier avec le concept TBO ?</div>
                <div class="options">
                    <label class="option"><input type="radio" name="pilot_fam" value="Pas du tout familier">Pas du tout familier</label>
                    <label class="option"><input type="radio" name="pilot_fam" value="Peu familier">Peu familier</label>
                    <label class="option"><input type="radio" name="pilot_fam" value="Neutre">Neutre</label>
                    <label class="option"><input type="radio" name="pilot_fam" value="Assez familier">Assez familier</label>
                    <label class="option"><input type="radio" name="pilot_fam" value="Très familier">Très familier</label>
                </div>

                <div class="q-title" style="margin-top:8px">3. Niveau d'implémentation du FF-ICE</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q3" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q3" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q3" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">4. Free Route Airspace (FRA)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q4" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q4" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q4" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">5. Utilisation des heures cibles (TTOT, CTOT, TTA, ETA/ATA)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q5" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q5" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q5" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">6. Procédures CDO/CCO basiques</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q6" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q6" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q6" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">7. Procédures CDO/CCO avancées</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q7" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q7" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q7" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">8. Approches PBN avancées (RNP AR)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q8" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q8" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q8" value="3">3</label>
                </div>

                <div class="q-title" style="margin-top:8px">9. Partage de trajectoire 4D (TBO avancé)</div>
                <div class="options">
                    <label class="radio-inline"><input type="radio" name="pilot_q9" value="1">1</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q9" value="2">2</label>
                    <label class="radio-inline"><input type="radio" name="pilot_q9" value="3">3</label>
                </div>

                <div style="margin-top:12px;">
                    <div class="q-title">Observations (facultatif)</div>
                    <textarea name="pilot_obs" id="pilot_obs" class="obs" placeholder="Vos remarques..."></textarea>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; gap:12px; margin-top:14px;">
                <button id="btnBack" class="btn-ghost">Retour</button>
                <div style="display:flex;gap:10px;">
                    <button id="btnPreview" class="btn-ghost">Aperçu local</button>
                    <button id="btnSubmit" class="btn-primary">Soumettre</button>
                </div>
            </div>
        </section>

        <section id="adminPage" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:800;color:#003e78">Espace Administration</div>
                <div class="muted">Accès protégé</div>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                <button id="refreshAdmin" class="btn-primary">Rafraîchir les données</button>
                <button id="closeAdmin" class="btn-ghost">Retour</button>
            </div>
            <div style="margin-top:12px;">
                <strong>Total réponses :</strong> <span id="totalResponses">0</span>
            </div>
            <div style="margin-top:12px;" class="table-responsive">
                <table id="tableResponses">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Pays</th>
                            <th>Fonction</th>
                            <th>Détails des réponses</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top:12px; height: 300px;">
                <canvas id="chartResponses"></canvas>
            </div>
        </section>

        <div id="previewArea" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>Aperçu local</strong>
                <button id="closePreview" class="btn-ghost">Fermer</button>
            </div>
            <pre id="previewContent" style="white-space:pre-wrap;margin-top:10px;"></pre>
        </div>

        <div style="text-align:right;margin-top:8px;font-size:13px;">
            <a href="#" id="adminFooterLink">Espace administration</a>
        </div>
    </main>

    <script>
        // CONFIGURATION
        const ADMIN_PWD = "adminTBO2025";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNm-d3Y6po1FoifNXkNDWn07h7SUVflmxmUV9vJRbyR5BnsPCvqxE_6SsjFW8Abc8E/exec";

        // Éléments DOM
        const countryEl = document.getElementById('country');
        const roleEl = document.getElementById('role');
        const startBtn = document.getElementById('startBtn');
        const adminLink = document.getElementById('adminLink');
        const adminFooterLink = document.getElementById('adminFooterLink');
        const accueil = document.getElementById('accueil');
        const questionnaire = document.getElementById('questionnaire');
        const adminPage = document.getElementById('adminPage');
        const previewArea = document.getElementById('previewArea');
        const btnBack = document.getElementById('btnBack');
        const btnSubmit = document.getElementById('btnSubmit');
        const btnPreview = document.getElementById('btnPreview');
        const closePreview = document.getElementById('closePreview');
        const tableBody = document.querySelector('#tableResponses tbody');
        const totalResponsesEl = document.getElementById('totalResponses');
        const chartCtx = document.getElementById('chartResponses').getContext('2d');
        
        let chartInstance = null;
        let isSubmitting = false;

        // === FONCTIONS CORRIGÉES ===

        // CORRECTION : Fonction pour afficher le bon formulaire
        function showFormForRole(role) {
            console.log('👤 Affichage formulaire pour:', role);
            
            // Cacher tous les formulaires
            document.querySelectorAll('[id^="form-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Afficher le formulaire correspondant
            const formToShow = document.getElementById('form-' + role);
            if (formToShow) {
                formToShow.classList.remove('hidden');
                console.log('✅ Affiché:', formToShow.id);
            } else {
                console.error('❌ Formulaire non trouvé:', 'form-' + role);
            }
            
            // Mettre à jour les en-têtes
            document.getElementById('headingRole').textContent = `Questionnaire – ${getRoleDisplayName(role)}`;
            document.getElementById('subHeading').textContent = `${countryEl.value} • ${role}`;
        }

        // CORRECTION : Fonction pour obtenir le nom affiché du rôle
        function getRoleDisplayName(role) {
            const roleNames = {
                'ATC': 'Contrôleur aérien (ATC)',
                'ATFM': 'Chef UQUIP (ATFM)', 
                'AIM': 'Chef AIM',
                'CNS': 'Chef CNS',
                'Pilote': 'Pilote'
            };
            return roleNames[role] || role;
        }

        // Envoi des données VERS Google Sheets - CORRIGÉ
        // ENVOI DES DONNÉES - VERSION PROXY POUR GITHUB PAGES
async function sendToSheet(data) {
  if (isSubmitting) {
    console.log('⏳ Soumission déjà en cours...');
    return false;
  }

  isSubmitting = true;
  btnSubmit.disabled = true;
  btnSubmit.textContent = 'Envoi en cours...';
  btnSubmit.classList.add('loading');
  
  try {
    console.log('🔄 Tentative d\'envoi des données:', data);

    // 🔥 NOUVELLE MÉTHODE : Utilisation d'un proxy via iframe
    const result = await sendViaProxy(data);
    
    console.log('📦 Réponse parsée:', result);

    if (result.status === 'success') {
      showMessage('✅ Vos réponses ont été enregistrées avec succès !', 'success');
      return true;
    } else {
      throw new Error(result.message || 'Erreur inconnue du serveur');
    }

  } catch (error) {
    console.error('🚨 Erreur lors de l\'envoi:', error);
    
    // Messages d'erreur plus précis
    let errorMessage = "Erreur d'envoi. ";
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      errorMessage += "Problème de connexion. Vérifiez votre connexion Internet.";
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage += "Impossible de contacter le serveur. Vérifiez votre connexion.";
    } else if (error.message.includes('HTTP error')) {
      errorMessage += `Erreur serveur (${error.message}). Réessayez plus tard.`;
    } else if (error.message.includes('CSP')) {
      errorMessage += "Problème de sécurité. Réessayez ou contactez l'administrateur.";
    } else {
      errorMessage += `Détails: ${error.message}`;
    }
    
    showMessage(errorMessage, 'error');
    return false;
  } finally {
    isSubmitting = false;
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Soumettre';
    btnSubmit.classList.remove('loading');
  }
}

// 🔥 NOUVELLE FONCTION : Envoi via proxy pour contourner CSP
function sendViaProxy(data) {
  return new Promise((resolve, reject) => {
    // Créer un iframe temporaire pour le proxy
    const proxyFrame = document.createElement('iframe');
    proxyFrame.style.display = 'none';
    proxyFrame.sandbox = "allow-scripts"; // Sécurité
    
    // Préparer les données pour le proxy
    const targetUrl = encodeURIComponent(SCRIPT_URL);
    const postData = encodeURIComponent(JSON.stringify(data));
    
    // Charger une page HTML locale comme proxy
    proxyFrame.src = `proxy.html?url=${targetUrl}&data=${postData}`;
    
    // Écouter les messages du proxy
    const messageHandler = (event) => {
      if (event.data.type === 'PROXY_SUCCESS') {
        console.log('✅ Réponse reçue via proxy:', event.data.result);
        // Nettoyer
        document.body.removeChild(proxyFrame);
        window.removeEventListener('message', messageHandler);
        // Parser la réponse
        try {
          const parsed = JSON.parse(event.data.result);
          resolve(parsed);
        } catch (e) {
          reject(new Error('Réponse invalide du serveur'));
        }
      } else if (event.data.type === 'PROXY_ERROR') {
        console.error('❌ Erreur proxy:', event.data.error);
        // Nettoyer
        document.body.removeChild(proxyFrame);
        window.removeEventListener('message', messageHandler);
        reject(new Error(event.data.error || 'Erreur de proxy'));
      }
    };
    
    window.addEventListener('message', messageHandler);
    
    // Gestion du timeout
    const timeout = setTimeout(() => {
      document.body.removeChild(proxyFrame);
      window.removeEventListener('message', messageHandler);
      reject(new Error('Timeout - Pas de réponse du serveur'));
    }, 15000); // 15 secondes timeout
    
    // Démarrer le processus
    proxyFrame.onload = () => {
      clearTimeout(timeout);
    };
    
    document.body.appendChild(proxyFrame);
  });
}
        // Fonction pour afficher les messages
        function showMessage(message, type) {
            const oldMessages = document.querySelectorAll('.success-message, .error-message');
            oldMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.innerHTML = message;
            
            questionnaire.insertBefore(messageDiv, questionnaire.firstChild);
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Récupération des données DEPUIS Google Sheets - CORRIGÉ
        async function loadFromSheet() {
            const refreshBtn = document.getElementById('refreshAdmin');
            const oldBtnText = refreshBtn.textContent;
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Chargement...';
            
            try {
                console.log('🔄 Chargement des données depuis:', SCRIPT_URL);
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP! statut: ${response.status}`);
                }

                const data = await response.json();
                console.log('📊 Données reçues:', data);

                if (!Array.isArray(data)) {
                    throw new Error('Format de données invalide - tableau attendu');
                }

                renderAdmin(data);
                return true;

            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:center;color:#ff6b6b;">
                            Erreur de chargement: ${error.message}
                            <br><small>Vérifiez que l'URL du script est correcte</small>
                        </td>
                    </tr>
                `;
                totalResponsesEl.textContent = '0';
                return false;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = oldBtnText;
            }
        }

        // Validation des données avant envoi
        function validateForm(data) {
            const errors = [];
            
            if (!data.pays) errors.push("Le pays est obligatoire");
            if (!data.fonction) errors.push("La fonction est obligatoire");
            
            return errors;
        }

        // Gestionnaire de soumission - VERSION AMÉLIORÉE
        btnSubmit.addEventListener('click', async () => {
            const data = collect();
            
            // Validation
            const errors = validateForm(data);
            if (errors.length > 0) {
                showMessage(`Champs manquants:\n${errors.join('\n')}`, 'error');
                return;
            }

            // Vérification des questions obligatoires
            const requiredQuestions = {
                'ATC': ['atc_exp', 'atc_fam'],
                'ATFM': ['atfm_q1', 'atfm_q2'],
                'AIM': ['aim_q1', 'aim_q6'],
                'CNS': ['cns_q1', 'cns_q6'],
                'Pilote': ['pilot_exp', 'pilot_fam']
            };
            
            const required = requiredQuestions[data.fonction] || [];
            const missingRequired = required.filter(q => !data[q]);
            
            if (missingRequired.length > 0) {
                if (!confirm(`Questions importantes non répondues. Souhaitez-vous quand même soumettre ?`)) {
                    return;
                }
            }

            const success = await sendToSheet(data);
            if (success) {
                // Réinitialisation après délai
                setTimeout(() => {
                    resetForm();
                    questionnaire.classList.add('hidden');
                    accueil.classList.remove('hidden');
                }, 2000);
            }
        });

        // Réinitialisation du formulaire
        function resetForm() {
            const visible = document.querySelector('#form-' + roleEl.value);
            if (visible) {
                visible.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
                visible.querySelectorAll('.option, .radio-inline').forEach(el => el.classList.remove('selected'));
                const ta = visible.querySelector('textarea');
                if (ta) ta.value = '';
            }
            
            // Réinitialiser les sélections
            countryEl.selectedIndex = 0;
            roleEl.selectedIndex = 0;
            toggleStart();
        }

        // === FONCTIONS EXISTANTES ===
        
        function collect() {
            const obj = {};
            obj.timestamp = new Date().toISOString();
            obj.pays = countryEl.value;
            obj.fonction = roleEl.value;
            
            const visible = document.querySelector('#form-' + roleEl.value);
            if (!visible) return obj;

            // Collecte des réponses radio
            visible.querySelectorAll('input[type="radio"]').forEach(r => {
                if (r.checked) obj[r.name] = r.value;
            });
            
            // Collecte des observations
            const obs = visible.querySelector('textarea');
            if (obs && obs.value.trim()) {
                obj['observations'] = obs.value.trim();
            }
            
            return obj;
        }

        function toggleStart() {
            startBtn.disabled = !(countryEl.value && roleEl.value);
        }

        // Gestionnaire d'administration
        function openAdmin() {
            const pwd = prompt('Mot de passe administrateur :');
            if (!pwd) return;
            
            if (pwd !== ADMIN_PWD) {
                alert('Mot de passe incorrect.');
                return;
            }
            
            accueil.classList.add('hidden');
            questionnaire.classList.add('hidden');
            adminPage.classList.remove('hidden');
            loadFromSheet();
        }

        // === INITIALISATION DES ÉVÉNEMENTS ===
        
        countryEl.addEventListener('change', toggleStart);
        roleEl.addEventListener('change', toggleStart);
        
        // CORRECTION : Gestionnaire du bouton Commencer
        startBtn.addEventListener('click', () => {
            if (!countryEl.value || !roleEl.value) {
                alert('Sélectionnez votre pays et votre fonction.');
                return;
            }
            
            console.log('🎯 Démarrage questionnaire:', {
                pays: countryEl.value,
                role: roleEl.value
            });
            
            // Cacher l'accueil
            accueil.classList.add('hidden');
            
            // Afficher le questionnaire
            questionnaire.classList.remove('hidden');
            
            // Afficher le bon formulaire
            showFormForRole(roleEl.value);
        });

        btnBack.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment retourner à l\'accueil ? Les données non envoyées seront perdues.')) {
                questionnaire.classList.add('hidden');
                accueil.classList.remove('hidden');
            }
        });

        adminLink.addEventListener('click', (e) => {
            e.preventDefault();
            openAdmin();
        });

        adminFooterLink.addEventListener('click', (e) => {
            e.preventDefault();
            openAdmin();
        });

        document.getElementById('closeAdmin').addEventListener('click', () => {
            adminPage.classList.add('hidden');
            accueil.classList.remove('hidden');
        });

        document.getElementById('refreshAdmin').addEventListener('click', loadFromSheet);

        // Preview
        btnPreview.addEventListener('click', () => {
            const obj = collect();
            document.getElementById('previewContent').textContent = JSON.stringify(obj, null, 2);
            previewArea.classList.remove('hidden');
        });

        closePreview.addEventListener('click', () => previewArea.classList.add('hidden'));

        // Interface visuelle pour les options
        document.addEventListener('click', (e) => {
            const opt = e.target.closest('.option');
            if (opt) {
                const input = opt.querySelector('input[type="radio"]');
                if (input) {
                    input.checked = true;
                    const parent = opt.parentElement;
                    parent.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                }
            }

            const rinline = e.target.closest('.radio-inline');
            if (rinline) {
                const input = rinline.querySelector('input[type="radio"]');
                if (input) {
                    input.checked = true;
                    const parent = rinline.parentElement;
                    parent.querySelectorAll('.radio-inline').forEach(r => r.classList.remove('selected'));
                    rinline.classList.add('selected');
                }
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            toggleStart();
            console.log('✅ Questionnaire TBO initialisé');
        });

        // Fonctions d'administration
        function renderAdmin(responses) {
            tableBody.innerHTML = '';
            if (!responses || responses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">Aucune donnée disponible</td></tr>';
                totalResponsesEl.textContent = '0';
                return;
            }

            responses.forEach(response => {
                const tr = document.createElement('tr');
                
                // Date formatée
                const dateCell = document.createElement('td');
                dateCell.textContent = new Date(response.timestamp).toLocaleDateString('fr-FR');
                
                // Pays
                const paysCell = document.createElement('td');
                paysCell.textContent = response.pays || 'Non spécifié';
                
                // Fonction
                const funcCell = document.createElement('td');
                funcCell.textContent = response.fonction || 'Non spécifié';
                
                // Détails des réponses
                const detailsCell = document.createElement('td');
                let detailsHtml = '<div style="max-height: 100px; overflow-y: auto; font-size: 12px;">';
                
                Object.keys(response).forEach(key => {
                    if (!['timestamp', 'pays', 'fonction'].includes(key) && response[key]) {
                        detailsHtml += `<div><strong>${key}:</strong> ${response[key]}</div>`;
                    }
                });
                
                detailsHtml += '</div>';
                detailsCell.innerHTML = detailsHtml;

                tr.appendChild(dateCell);
                tr.appendChild(paysCell);
                tr.appendChild(funcCell);
                tr.appendChild(detailsCell);
                tableBody.appendChild(tr);
            });

            totalResponsesEl.textContent = responses.length;
            updateChart(responses);
        }

        function updateChart(responses) {
            const counts = {};
            responses.forEach(r => {
                counts[r.fonction] = (counts[r.fonction] || 0) + 1;
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Réponses par fonction',
                        data: data,
                        backgroundColor: [
                            'rgba(10, 108, 241, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgb(10, 108, 241)',
                            'rgb(255, 99, 132)',
                            'rgb(75, 192, 192)',
                            'rgb(255, 159, 64)',
                            'rgb(153, 102, 255)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>